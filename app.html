<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-app: #f3f4f6; --bg-panel: #ffffff; --bg-ribbon: #ffffff; --text-main: #1f2937;
            --text-muted: #6b7280; --border: #e5e7eb; --accent: #2563eb; --accent-hover: #1d4ed8;
            --highlight: #eff6ff; --verse-num: #d97706; --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-app: #111827; --bg-panel: #1f2937; --bg-ribbon: #1f2937; --text-main: #f3f4f6;
            --text-muted: #9ca3af; --border: #374151; --accent: #3b82f6; --accent-hover: #60a5fa;
            --highlight: #374151; --verse-num: #f59e0b; --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: 0.2s; }
        
        #ribbon { flex: 0 0 auto; background: var(--bg-ribbon); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: var(--shadow); z-index: 10; transition: 0.2s; }
        #ribbon.collapsed .ribbon-content { display: none !important; }
        
        .ribbon-tabs { display: flex; gap: 2px; padding: 0 10px; background: var(--bg-app); justify-content: space-between; }
        .ribbon-tab { padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 500; color: var(--text-muted); border-top-left-radius: 6px; border-top-right-radius: 6px; margin-top: 4px; transition: 0.2s; }
        .ribbon-tab.active { background: var(--bg-ribbon); color: var(--accent); font-weight: 600; }
        
        .ribbon-content { padding: 10px 20px; display: flex; gap: 24px; align-items: stretch; min-height: 60px; overflow-x: auto; }
        .ribbon-group { display: flex; flex-direction: column; gap: 8px; border-right: 1px solid var(--border); padding-right: 20px; flex-shrink: 0; }
        .ribbon-group:last-child { border-right: none; }
        .ribbon-label { margin-top: auto; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; text-align: center; font-weight: 700; padding-top: 5px; }
        
        #workspace { flex: 1; display: flex; padding: 10px; gap: 10px; background: var(--bg-app); min-height: 0; position: relative; }
        
        .pane { flex: 1; background: var(--bg-panel); border: 1px solid var(--border); display: flex; flex-direction: column; border-radius: 6px; box-shadow: var(--shadow); overflow: hidden; min-width: 0; min-height: 0; transition: 0.3s ease; }
        .pane.maximized { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; margin: 10px; height: calc(100vh - 20px); }
        .pane.minimized { flex: 0 0 40px; height: 40px; min-height: 40px; }
        .pane.closed { display: none; }
        
        .pane-header { flex: 0 0 40px; background: #2563eb; color: white; padding: 0 12px; font-size: 13px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .pane-header select { color: white; background: transparent; border: 1px solid rgba(255,255,255,0.3); font-weight: bold; outline:none; }
        .pane-header select option { color: black; }
        
        .win-btn { color: white; opacity: 0.8; cursor:pointer; padding:4px; border-radius:3px; font-weight:bold; }
        .win-btn:hover { background: rgba(255,255,255,0.2); opacity: 1; }
        
        .pane-content { 
            flex: 1; 
            overflow-y: auto !important; 
            padding: 24px; /* More breathing room */
            font-family: 'Merriweather', serif; 
            /* Font size is now dynamic via JS state */
            line-height: 1.7; 
            color: var(--text-main);
            background: var(--bg-panel);
            scrollbar-gutter: stable;
        }
        .comm-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .ref-link { color: var(--accent); font-weight: 600; cursor: pointer; }
        .ref-link:hover { text-decoration: underline; }
        
        mark { background-color: #fef08a; color: #854d0e; padding: 0 2px; border-radius: 2px; font-weight: 600; }
        .verse-row { padding: 4px 8px; margin: 2px 0; border-radius: 4px; cursor: pointer; transition: 0.1s; }
        .verse-row:hover { background-color: var(--bg-app); }
        .verse-row.active { background-color: var(--highlight); border-left: 3px solid var(--accent); }
        
        .v-num { color: var(--verse-num); font-weight: bold; margin-right: 8px; font-size: 0.85em; font-family: 'Inter', sans-serif; }
        .strongs-tag { font-size: 0.75em; color: #16a34a; font-weight: bold; cursor: pointer; margin-left: 2px; }
        
        .v-link { display: inline-block; font-size: 10px; color: var(--accent); background: var(--bg-app); border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; margin-right: 4px; margin-bottom: 4px; font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .v-link:hover { background: var(--accent); color: white; }
        .verse-links { margin-top: 6px; padding-left: 20px; display: flex; flex-wrap: wrap; }
        
        .sidebar-item { padding: 6px 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-family: 'Inter', sans-serif; font-size: 13px; }
        .sidebar-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .sidebar-item:hover { background: rgba(0,0,0,0.05); }
        
        .control-pod { display: flex; gap: 8px; align-items: center; background: var(--bg-app); padding: 4px 6px; border-radius: 6px; border: 1px solid var(--border); transition: 0.2s; }
        .control-pod:hover { border-color: var(--accent); }
        
        .module-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 4px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: 0.1s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; }
        .module-card.active { background: var(--accent); color: white; border-color: var(--accent); }
        .module-card:hover:not(.active) { background: var(--bg-app); border-color: var(--accent); }
        
        .primary { background: var(--accent) !important; color: white !important; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>

<div id="ribbon">
    <div class="ribbon-tabs">
        <div style="display:flex; gap:2px;">
            <div class="ribbon-tab active" onclick="switchTab('tab-bible')">Bible</div>
            <div class="ribbon-tab" onclick="switchTab('tab-comm')">Commentaries</div>
            <div class="ribbon-tab" onclick="switchTab('tab-dict')">Dictionaries</div>
            <div class="ribbon-tab" onclick="switchTab('tab-lex')">Lexicons</div>
            <div class="ribbon-tab" onclick="switchTab('tab-search')">Search</div>
            <div class="ribbon-tab" onclick="switchTab('tab-win')">Windows</div>
            <div class="ribbon-tab" onclick="switchTab('tab-settings')">Settings</div>
        </div>
        <div style="display:flex; align-items:center; padding-right:10px;">
            <button onclick="toggleRibbon()" class="ribbon-collapse-btn" style="border:none; background:transparent; cursor:pointer; color:var(--text-muted); font-weight:900; font-size:20px;">^</button>
        </div>
    </div>
    
    <div class="ribbon-content" id="tab-bible">
        <div class="ribbon-group"><div class="control-pod">
            <button onclick="navStep(-1)">‚Üê</button>
            <select id="sel-book" onchange="navigate()">
            </select>
            <input type="number" id="inp-chapter" value="1" min="1" style="width:40px; border:none; background:transparent; font-weight:bold; text-align:center;" onchange="navigate()">
            <select id="sel-verse" onchange="setVerse(this.value); scrollVerse(this.value)" style="width:50px; border:none; background:transparent; font-weight:bold;">
            </select>
            <button onclick="navStep(1)">‚Üí</button>
        </div><div class="ribbon-label">Navigation</div></div>
        
        <div class="ribbon-group"><div class="control-pod">
            <select id="sel-version" onchange="reloadPanes()">
            </select>
            <button onclick="toggleInterlinear()" id="btn-interlinear">Interlinear: OFF</button>
        </div><div class="ribbon-label">Translation</div></div>
        
        <div class="ribbon-group"><button onclick="changePaneContent('pane-2', 'xrefs')" class="primary">Show Cross-Refs</button><div class="ribbon-label">Study Tools</div></div>
    </div>

    <div class="ribbon-content" id="tab-comm" style="display:none;">
        <div class="ribbon-group" style="flex:1; border:none;">
            <div id="comm-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:8px;">
            </div>
            <div class="ribbon-label">Select Commentary</div>
        </div>
    </div>

    <div class="ribbon-content" id="tab-dict" style="display:none;">
        <div class="ribbon-group"><div class="control-pod">
            <select id="sel-dict-mod" onchange="state.dictModule=this.value; changePaneContent('pane-2','dictionary')">
                <option value="EASTON">Easton's</option><option value="SMITH">Smith's</option><option value="ATSD">ATSD</option><option value="NAMES">Names</option>
            </select>
            <div style="height:20px; border-left:1px solid var(--border); margin:0 2px;">
            </div>
            <input type="text" id="inp-dict-search" placeholder="Search..." onkeydown="if(event.key==='Enter') searchDict()">
            <button onclick="searchDict()" class="primary">Find</button>
        </div><div class="ribbon-label">Dictionary</div></div>
    </div>

    <div class="ribbon-content" id="tab-lex" style="display:none;">
        <div class="ribbon-group"><div class="control-pod">
            <select id="sel-lex-mod" onchange="state.lexModule=this.value; changePaneContent('pane-2','lex_browse')">
                <option value="HEBREW">Hebrew</option><option value="GREEK">Greek</option>
            </select>
            <div style="height:20px; border-left:1px solid var(--border); margin:0 2px;">
            </div>
            <input type="text" id="inp-lex-search" placeholder="H123..." onkeydown="if(event.key==='Enter') searchLex()">
            <button onclick="searchLex()" class="primary">Find</button>
        </div><div class="ribbon-label">Lexicon</div></div>
    </div>

    <div class="ribbon-content" id="tab-search" style="display:none;">
        <div class="ribbon-group"><div class="control-pod">
            <select id="sel-search-scope"><option value="ALL">Entire Bible</option><option value="OT">Old Testament</option><option value="NT">New Testament</option><option value="CURRENT">Current Book</option></select>
            <div style="height:20px; border-left:1px solid var(--border); margin:0 2px;">
            </div>
            <input type="text" id="inp-bible-search" placeholder="Words..." onkeydown="if(event.key==='Enter') searchBible()" style="min-width:200px; border:none; background:transparent;">
            <button onclick="searchBible()" class="primary">Search</button>
        </div><div class="ribbon-label">Search</div></div>
    </div>

    <div class="ribbon-content" id="tab-win" style="display:none;">
        <div class="ribbon-group"><div class="control-pod"><button onclick="setLayout('vertical')">|| Vertical</button><div style="height:20px; border-left:1px solid var(--border); margin:0 2px;"></div><button onclick="setLayout('horizontal')">= Horizontal</button></div><div class="ribbon-label">Layout</div></div>
        <div class="ribbon-group"><button onclick="resetLayout()">Restore Windows</button><div class="ribbon-label">Manager</div></div>
    </div>

        <div class="ribbon-content" id="tab-settings" style="display:none;">

            <div class="ribbon-group">

                <button onclick="toggleTheme()" id="btn-theme">Toggle Theme</button>

                <div class="ribbon-label">Appearance</div>

            </div>

            <div class="ribbon-group">

                <div class="control-pod">

                    <button onclick="changeFontSize(-1)" style="font-size:14px; font-weight:bold;">A-</button>

                    <span id="lbl-font-size" style="font-size:12px; min-width:30px; text-align:center; font-weight:600; color:var(--text-muted);">18px</span>

                    <button onclick="changeFontSize(1)" style="font-size:16px; font-weight:bold;">A+</button>

                </div>

                <div class="ribbon-label">Text Size</div>

            </div>

        </div>
</div>

<div id="workspace">
    <div class="pane" id="pane-1" data-type="bible">
        <div class="pane-header">
            <div>
                <select onchange="changePaneContent('pane-1', this.value)">
                    <option value="bible">Bible</option>
                    <option value="commentary">Commentary</option>
                </select>
                <span id="pane-1-title"></span>
            </div>
            <div class="win-controls">
                <div class="win-btn" onclick="toggleMin('pane-1')">_</div>
                <div class="win-btn" onclick="toggleMax('pane-1')">‚ñ°</div>
                <div class="win-btn close" onclick="closePane('pane-1')">√ó</div>
            </div>
        </div>
        <div class="pane-content" id="pane-1-content"></div>
    </div>
    <div class="pane" id="pane-2" data-type="commentary">
        <div class="pane-header">
            <div>
                <select onchange="changePaneContent('pane-2', this.value)">
                    <option value="commentary">Commentary</option>
                    <option value="xrefs">Cross-Refs</option>
                    <option value="dictionary">Dictionary</option>
                    <option value="lex_browse">Lexicon</option>
                    <option value="search">Search</option>
                </select>
                <span id="pane-2-title"></span>
            </div>
            <div class="win-controls">
                <div class="win-btn" onclick="toggleMin('pane-2')">_</div>
                <div class="win-btn" onclick="toggleMax('pane-2')">‚ñ°</div>
                <div class="win-btn close" onclick="closePane('pane-2')">√ó</div>
            </div>
        </div>
        <div class="pane-content" id="pane-2-content"></div>
    </div>
</div>

<script>
    // --- State & Config ---
    const state = { 
        book:"Genesis", chapter:1, verse:1, version:"KJV", 
        commModule:"mhc", dictModule:"EASTON", lexModule:"HEBREW", 
        searchQuery:"", lookupTerm:"", lookupType:"dictionary", interlinear:false,
        fontSize: 18 // Default font size
    };
    
    const otBooks = ["Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth","1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah","Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah","Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah","Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi"];
    const ntBooks = ["Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians","Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians","1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter","1 John","2 John","3 John","Jude","Revelation"];
    
    const BIBLE_STRUCTURE = { "Genesis":[31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26],"Exodus":[22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38],"Leviticus":[17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,37,27,24,33,44,23,55,46,34],"Numbers":[54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,41,30,25,18,65,23,31,40,16,54,42,56,29,34,13],"Deuteronomy":[46,37,29,49,33,25,26,20,29,22,32,32,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,68,29,20,30,52,29,12],"Joshua":[18,24,17,24,15,27,26,35,27,43,23,24,33,15,63,10,18,28,51,9,45,34,16,33],"Judges":[36,23,31,24,31,40,25,35,57,18,40,15,25,20,20,31,13,31,30,48,25],"Ruth":[22,23,18,22],"1 Samuel":[28,36,21,22,12,21,17,22,27,27,15,25,23,52,35,23,58,30,24,42,15,23,29,22,44,25,12,25,11,31,13],"2 Samuel":[27,32,39,12,25,23,29,18,13,19,27,31,39,33,37,23,29,33,43,26,22,51,39,25],"1 Kings":[53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,43,29,53],"2 Kings":[18,25,27,44,27,33,20,29,37,36,21,21,25,29,38,20,41,37,37,21,26,20,37,20,30],"1 Chronicles":[54,55,24,43,26,81,40,40,44,14,47,40,14,17,29,43,27,17,19,8,30,19,32,31,31,32,34,21,30],"2 Chronicles":[17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,33,25,33,27,23],"Ezra":[11,70,13,24,17,22,28,36,15,44],"Nehemiah":[11,20,32,23,19,19,73,18,38,39,36,47,31],"Esther":[22,23,15,17,14,14,10,17,32,3],"Job":[22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17],"Psalms":[6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,6,7,23,13,11,11,17,12,8,12,11,10,13,20,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,13,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,176,7,8,9,4,8,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6],"Proverbs":[33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31],"Ecclesiastes":[18,26,22,16,20,12,29,17,18,20,10,14],"Song of Solomon":[17,17,11,16,16,13,13,14],"Isaiah":[31,22,26,6,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,24,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,11,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24],"Jeremiah":[19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,34],"Lamentations":[22,22,66,22,22],"Ezekiel":[28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,63,24,32,14,49,32,31,49,27,17,21,36,26,21,26,18,32,33,31,15,38,28,23,29,49,26,20,27,31,25,24,23,35],"Daniel":[21,49,30,37,31,28,28,27,27,21,45,13],"Hosea":[11,23,5,19,15,11,16,14,17,15,12,14,16,9],"Joel":[20,32,21],"Amos":[15,16,15,13,27,14,17,14,15],"Obadiah":[21],"Jonah":[17,10,10,11],"Micah":[16,13,12,13,15,16,20],"Nahum":[15,13,19],"Habakkuk":[17,20,19],"Zephaniah":[18,15,20],"Haggai":[15,23],"Zechariah":[21,13,10,14,11,15,14,23,17,12,17,14,9,21],"Malachi":[14,17,18,6],"Matthew":[25,23,17,25,48,34,29,34,38,42,30,50,58,36,39,28,27,35,30,34,46,46,39,51,46,75,66,20],"Mark":[45,28,35,41,43,56,37,38,50,52,33,44,37,72,47,20],"Luke":[80,52,38,44,39,49,50,56,62,42,54,59,35,35,32,31,37,43,48,47,38,71,56,53],"John":[51,25,36,54,47,71,53,59,41,42,57,50,38,31,27,33,26,40,42,31,25],"Acts":[26,47,26,37,42,15,60,40,43,48,30,25,52,28,41,40,34,28,41,38,40,30,35,27,27,32,44,31],"Romans":[32,29,31,25,21,23,25,39,33,21,36,21,14,23,33,27],"1 Corinthians":[31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24],"2 Corinthians":[24,17,18,18,21,18,16,24,15,18,33,21,14],"Galatians":[24,21,29,31,26,18],"Ephesians":[23,22,21,32,33,24],"Philippians":[30,30,21,23],"Colossians":[29,23,25,18],"1 Thessalonians":[10,20,13,18,28],"2 Thessalonians":[12,17,18],"1 Timothy":[20,15,16,16,25,21],"2 Timothy":[18,26,17,22],"Titus":[16,15,15],"Philemon":[25],"Hebrews":[14,18,19,16,14,20,28,13,28,39,40,29,25],"James":[27,26,18,17,20],"1 Peter":[25,25,22,19,14],"2 Peter":[21,22,18],"1 John":[10,29,24,21,21],"2 John":[13],"3 John":[14],"Jude":[25],"Revelation":[20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21] };
    const moduleNames = { "ACC":"Adam Clarke's Commentary","BARNES":"Barnes' Notes","FBN":"Family Bible Notes","GBN":"Geneva Bible Notes","JFB":"Jamieson, Fausset, Brown","JWN":"John Wesley's Notes","MHC":"Matthew Henry's Commentary","MHCC":"Matthew Henry's Concise","PNTC":"People's New Testament","RWP":"Robertson's Word Pictures","SCM":"Scofield Reference Notes","SDC":"Seventh Day Adventist","TEACHER":"Teacher's Commentary","TFG":"The Fourfold Gospel","TOD":"Treasury of David","TSK":"Treasury of Scripture Knowledge","WBN":"Wycliffe Bible Notes" };
    const versionNames = { "ASV":"American Standard","BBE":"Basic English","DBY":"Darby Bible","KJV":"King James Version","LGB":"Literal Greek","LSV":"Literal Standard","MKJV":"Modern KJV","MNT":"Moffatt NT","NAS95":"NASB 1995","NASB":"NASB","NIV":"NIV","NKJV":"NKJV","NRSV":"NRSV","RSV":"RSV","SRV":"Spanish Reina Valera","SRVA":"Spanish Reina Valera Antigua","TCNT":"TCNT","TR":"Textus Receptus","WEB":"World English","WNT":"Weymouth NT","YLT":"Young's Literal" };

    // --- Core Logic ---
    function updateThemeUI(t){ let b=document.getElementById('btn-theme'); if(b) b.innerText=(t==='dark'?'Switch to Light':'Switch to Dark'); }
    function toggleTheme(){ let b=document.body; let cur=b.getAttribute('data-theme'); let n=(cur==='dark'?'light':'dark'); b.setAttribute('data-theme',n); localStorage.setItem('theme',n); updateThemeUI(n); }
        function switchTab(tabId) {
        document.querySelectorAll('.ribbon-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabId).style.display = 'flex';
        document.querySelectorAll('.ribbon-tab').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        // Auto-switch Pane 2 Context based on Tab
        if (tabId === 'tab-comm') changePaneContent('pane-2', 'commentary');
        if (tabId === 'tab-dict') changePaneContent('pane-2', 'dictionary');
        if (tabId === 'tab-lex') changePaneContent('pane-2', 'lex_browse');
        if (tabId === 'tab-search') {
            changePaneContent('pane-2', 'search');
            // Auto-focus the search box
            setTimeout(() => document.getElementById('inp-bible-search').focus(), 50);
        }
    }
    function toggleRibbon(){ document.getElementById('ribbon').classList.toggle('collapsed'); }
    function toggleInterlinear(){ state.interlinear=!state.interlinear; let b=document.getElementById('btn-interlinear'); b.innerText=(state.interlinear?"Interlinear: ON":"Interlinear: OFF"); b.style.color=(state.interlinear?"var(--accent)":"var(--text-main)"); reloadPanes(); }
    function setCommModule(mod){ state.commModule=mod.toLowerCase(); changePaneContent('pane-2','commentary'); }
    function setVerse(v){ state.verse=v; let s=document.getElementById('sel-verse'); if(s) s.value=v; document.querySelectorAll('.verse-row').forEach(e=>e.classList.remove('active')); let active=document.getElementById(`v-${v}`); if(active) active.classList.add('active'); updateContextPanes(); }
    
    function navigate(){ 
        let nb=document.getElementById('sel-book').value; 
        let nc=document.getElementById('inp-chapter').value; 
        if(nb!==state.book){ 
            state.book=nb; state.chapter=1; state.verse=1; 
            document.getElementById('inp-chapter').value=1; 
        } else { 
            state.chapter=nc; state.verse=1; 
        } 
        updateVerseSelector(); reloadPanes(); 
    }
    
    function navStep(d){ let c=parseInt(document.getElementById('inp-chapter').value)+d; if(c<1)c=1; document.getElementById('inp-chapter').value=c; navigate(); }
    
    function updateVerseSelector(){ 
        let s=document.getElementById('sel-verse'); s.innerHTML=''; let count=0; 
        if(BIBLE_STRUCTURE[state.book]){ 
            let idx=parseInt(state.chapter)-1; 
            if(BIBLE_STRUCTURE[state.book][idx]) count=BIBLE_STRUCTURE[state.book][idx]; 
        } 
        for(let i=1;i<=count;i++){ 
            let o=document.createElement('option'); o.value=i; o.text=i; 
            if(i==state.verse) o.selected=true; s.appendChild(o); 
        } 
    }
    
    function scrollVerse(v){ let t=document.getElementById(`v-${v}`); if(t) t.scrollIntoView({behavior:'smooth',block:'start'}); }
    
    function jumpTo(b,c,v){ 
        state.book=b; state.chapter=c; state.verse=v; 
        document.getElementById('sel-book').value=b; document.getElementById('inp-chapter').value=c; 
        updateVerseSelector(); 
        if(document.getElementById('pane-1').dataset.type!=='bible') changePaneContent('pane-1','bible'); 
        else reloadPanes(); 
    }
    
    function openComm(m,v){ state.verse=v; setCommModule(m); }
    function setLayout(t){ document.getElementById('workspace').className=(t==='vertical'?'layout-vertical':'layout-horizontal'); }
    function toggleMin(id){ document.getElementById(id).classList.toggle('minimized'); }
    function toggleMax(id){ document.getElementById(id).classList.toggle('maximized'); }
    function closePane(id){ document.getElementById(id).classList.add('closed'); }
    function resetLayout(){ document.querySelectorAll('.pane').forEach(e=>e.classList.remove('closed','minimized','maximized')); }
    
    function changePaneContent(paneId, type) {
        const pane = document.getElementById(paneId);
        pane.dataset.type = type;
        const titleSpan = document.getElementById(`${paneId}-title`);
        const select = pane.querySelector('select');
        if(select) select.value = type;
        
        let commTitle = `Commentary (${state.commModule.toUpperCase()})`;
        if (moduleNames[state.commModule.toUpperCase()]) commTitle = moduleNames[state.commModule.toUpperCase()];

        const titles = {
            'bible': 'Bible Text',
            'commentary': commTitle,
            'dictionary': `Dictionary (${state.dictModule})`,
            'lex_browse': `Lexicon (${state.lexModule})`,
            'xrefs': 'Cross References',
            'search': 'Search Results'
        };
        titleSpan.innerText = titles[type] || 'Pane';
        loadPane(paneId);
    }

    function searchDict(){ let t=document.getElementById('inp-dict-search').value; if(t){ state.lookupTerm=t; state.lookupType='dictionary'; changePaneContent('pane-2','dictionary'); } }
    function searchLex(){ let t=document.getElementById('inp-lex-search').value; if(t){ state.lookupTerm=t; state.lookupType=(state.lexModule==='HEBREW'?'strong_hebrew':'strong_greek'); changePaneContent('pane-2','lex_browse'); } }
    function switchRefModule(m){ if(m==='HEBREW'||m==='GREEK'){ state.lexModule=m; changePaneContent('pane-2','lex_browse'); } else { state.dictModule=m; changePaneContent('pane-2','dictionary'); } }
    function filterSidebar(q){ let i=document.querySelectorAll('.sidebar-item'); let l=q.toLowerCase(); i.forEach(e=>e.style.display=(e.innerText.toLowerCase().includes(l)?'block':'none')); }
    function highlightItem(e){ document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active')); e.classList.add('active'); }
    function showDef(t,ty){ state.lookupTerm=t; state.lookupType=ty; if(ty.includes('strong')) state.lexModule=(ty.includes('hebrew')?'HEBREW':'GREEK'); changePaneContent('pane-2',(ty.includes('strong')?'lex_browse':'dictionary')); }
    function reloadPanes(){ loadPane('pane-1'); updateContextPanes(); }

    function loadPane(id){
        let p=document.getElementById(id); let ty=p.dataset.type; let c=document.getElementById(`${id}-content`); let t=document.getElementById(`${id}-title`);
        state.version=document.getElementById('sel-version').value||'KJV';
        if(ty==='bible'){
            t.innerText=`${state.book} ${state.chapter} (${state.version})`;
            fetch(`api.php?action=text&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&version=${state.version}&interlinear=${state.interlinear}`)
            .then(r=>r.json()).then(data=>{
                let h=''; data.verses.forEach(v=>{
                    let txt=v.text; if(!state.interlinear){ txt=txt.replace(/God/g,'God<sup class="strongs" onclick="event.stopPropagation(); showDef(\'H430\',\'strong_hebrew\')">H430</sup>').replace(/beginning/g,'beginning<sup class="strongs" onclick="event.stopPropagation(); showDef(\'H7225\',\'strong_hebrew\')">H7225</sup>'); } 
                    let lnks=''; if(v.modules){ lnks='<div class="verse-links">'; v.modules.split(',').forEach(m=>{ lnks+=`<span class="v-link" onclick="event.stopPropagation(); openComm('${m}',${v.verse})" >${m}</span>`; }); lnks+='</div>'; }
                    h+=`<div class="verse-row ${v.verse==state.verse?'active':''}" id="v-${v.verse}" onclick="setVerse(${v.verse})"><span class="v-num">${v.verse}</span>${txt}${lnks}</div>`;
                });
                c.innerHTML=h; setTimeout(()=>scrollVerse(state.verse),100);
            });
        } else updatePaneContent(id);
    }

    function updateContextPanes(){ document.querySelectorAll('.pane').forEach(p=>{ if(p.dataset.type!=='bible') updatePaneContent(p.id); }); }

    function updatePaneContent(id){
        let p=document.getElementById(id); let ty=p.dataset.type; let c=p.querySelector('.pane-content');
        c.style.display='block'; c.innerHTML='Loading...';
        if(ty==='commentary'){
            c.style.display='flex'; c.style.padding='0';
            let s='<div style="width:60px; border-right:1px solid var(--border); overflow-y:auto; background:var(--bg-app); display:flex; flex-direction:column; align-items:center; padding:10px 0; gap:5px;">';
            for(let i=1;i<=80;i++){ s+=`<div onclick="setVerse(${i})" style="width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; cursor:pointer; font-size:12px; font-weight:bold; ${(i==state.verse?'background:var(--accent); color:white;':'')} ">${i}</div>`; } s+='</div>';
            c.innerHTML=s+'<div style="flex:1; padding:20px; overflow-y:auto;" id="comm-scroll">Loading...</div>';
            fetch(`api.php?action=commentary&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&verse=${state.verse}&module=${state.commModule}`)
            .then(r=>r.json()).then(data=>{ document.getElementById('comm-scroll').innerHTML=`<div class="comm-card"><h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">${state.book} ${state.chapter}:${state.verse} (${state.commModule.toUpperCase()})</h3>${data.text||"None."}</div>`; });
        } else if(ty==='xrefs'){
            fetch(`api.php?action=xrefs&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&verse=${state.verse}`)
            .then(r=>r.json()).then(data=>{
                let h='<div class="comm-card"><h3>Cross References</h3><div style="display:flex; flex-wrap:wrap; gap:8px;">';
                if(!data.xrefs||data.xrefs.length===0) h+='None.'; else data.xrefs.forEach(x=>{ h+=`<span class="v-link" onclick="jumpTo('${x.book}',${x.chapter},${x.verse})" >${x.book} ${x.chapter}:${x.verse}</span>`; });
                c.innerHTML=h+'</div></div>';
            });
        } else if(ty==='dictionary'||ty==='lex_browse'){
            c.style.display='flex'; c.style.flexDirection='column'; c.style.padding='0';
            let cur=(ty==='lex_browse'?state.lexModule:state.dictModule);
            let h=`<div style="flex:0 0 40px; background:var(--bg-app); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 10px; gap:8px;"><span style="font-size:11px; font-weight:bold;">Source:</span><select onchange="switchRefModule(this.value)"><optgroup label="Dictionaries"><option value="EASTON" ${cur==='EASTON'?'selected':''}>Easton</option><option value="SMITH" ${cur==='SMITH'?'selected':''}>Smith</option><option value="ATSD" ${cur==='ATSD'?'selected':''}>ATSD</option><option value="NAMES" ${cur==='NAMES'?'selected':''}>Names</option></optgroup><optgroup label="Lexicons"><option value="HEBREW" ${cur==='HEBREW'?'selected':''}>Hebrew</option><option value="GREEK" ${cur==='GREEK'?'selected':''}>Greek</option></optgroup></select><div style="flex:1;"></div><input type="text" placeholder="Filter..." onkeyup="filterSidebar(this.value)"></div><div style="flex:1; display:flex; overflow:hidden;"><div id="dict-sidebar" style="width:220px; border-right:1px solid var(--border); overflow-y:auto; background:var(--bg-app);"><div id="topics-list"></div></div><div style="flex:1; padding:20px; overflow-y:auto;" id="dict-display"></div></div>`;
            c.innerHTML=h; let list=document.getElementById('topics-list'); let disp=document.getElementById('dict-display');
            fetch(`api.php?action=topics&module=${cur}`).then(r=>r.json()).then(data=>{
                let type=(cur==='HEBREW'?'strong_hebrew':cur==='GREEK'?'strong_greek':'dictionary');
                data.topics.forEach(t=>{ 
                    let d=document.createElement('div'); 
                    d.className='sidebar-item'+(t.id===state.lookupTerm?' active':''); 
                    d.innerText=t.label; 
                    d.onclick=()=>{ highlightItem(d); showDef(t.id,type); }; 
                    list.appendChild(d); 
                });
            });
            if(state.lookupTerm){ fetch(`api.php?action=definition&term=${encodeURIComponent(state.lookupTerm)}&type=${state.lookupType}&module=${cur}`).then(r=>r.json()).then(data=>{ disp.innerHTML=`<h2>${state.lookupTerm}</h2><div style="font-size:16px;">${data.definition.replace(/\n/g,'<br>')}</div>`; }); }
        } else if (type === 'search') {
            if (!state.searchQuery) {
                c.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:var(--text-muted); text-align:center;">
                                    <div>
                                        <div style="font-size:40px; margin-bottom:10px;">üîç</div>
                                        Enter keywords in the Search tab to find verses
                                    </div>
                                </div>`;
                return;
            }
            fetch(`api.php?action=search&q=${encodeURIComponent(state.searchQuery)}&version=${state.version}&scope=${encodeURIComponent(state.searchScope)}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById(`${id}-title`).innerText = `Search: ${state.searchQuery} (${data.count})`;
                    let h = `<div style="padding:0 15px 15px 15px;">`;
                    if (data.count > 200) {
                        h = `<div style="padding:8px 15px; font-size:11px; color:var(--text-muted); background:var(--bg-app); border-bottom:1px solid var(--border); margin-bottom:15px;">
                                    Showing first 200 of ${data.count} results
                                </div>` + h;
                    }
                    if(!data.results || data.results.length === 0) h+='<p>No results found.</p>'; 
                    else data.results.forEach(r=>{ 
                        h+=`<div class="comm-card" style="cursor:pointer; margin-top:10px;" onclick="jumpTo('${r.book_name.replace(/'/g, "\'")}',${r.chapter},${r.verse})">
                                <b style="color:var(--accent); font-size:12px; text-transform:uppercase;">${r.book_name} ${r.chapter}:${r.verse}</b><br>${r.text}
                            </div>`; 
                    });
                    c.innerHTML = h + '</div>';
                });
        }
    }

    function changeFontSize(delta) {
        state.fontSize += delta;
        if(state.fontSize < 12) state.fontSize = 12;
        if(state.fontSize > 32) state.fontSize = 32;
        
        applyFontSize();
        localStorage.setItem('fontSize', state.fontSize);
    }

    function applyFontSize() {
        document.querySelectorAll('.pane-content').forEach(el => {
            el.style.fontSize = `${state.fontSize}px`;
        });
        document.getElementById('lbl-font-size').innerText = `${state.fontSize}px`;
    }

    // --- Init ---
    window.onload = function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeUI(savedTheme);
        
        const savedSize = localStorage.getItem('fontSize');
        if(savedSize) state.fontSize = parseInt(savedSize);
        applyFontSize();

        fetch('api.php?action=version_list').then(r=>r.json()).then(data=>{
            const sel = document.getElementById('sel-version'); sel.innerHTML='';
            data.versions.forEach(v=>{ let opt=document.createElement('option'); opt.value=v; opt.text=versionNames[v]||v; if(v==='KJV') opt.selected=true; sel.appendChild(opt); });
        });
        fetch('api.php?action=commentary_list').then(r=>r.json()).then(data=>{
            const container = document.querySelector('#tab-comm .ribbon-group > div');
            container.style.display = 'grid'; container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(220px, 1fr))'; container.style.gap = '8px'; container.style.width = '100%';
            container.innerHTML = ''; 
            data.modules.forEach(mod=>{
                const btn = document.createElement('div'); btn.className = 'module-card';
                btn.style.cssText = "background:var(--bg-panel); border:1px solid var(--border); padding:8px 12px; border-radius:4px; cursor:pointer; font-size:12px; display:flex; align-items:center; min-height:30px;";
                if (state.commModule.toUpperCase() === mod) { btn.classList.add('active'); btn.style.borderColor = 'var(--accent)'; btn.style.backgroundColor = 'var(--bg-app)'; }
                btn.innerText = moduleNames[mod] || mod; btn.title = btn.innerText;
                btn.onclick = () => { document.querySelectorAll('.module-card').forEach(b=>{b.classList.remove('active'); b.style.borderColor='var(--border)'; b.style.backgroundColor='var(--bg-panel)'}); btn.classList.add('active'); btn.style.borderColor='var(--accent)'; btn.style.backgroundColor='var(--bg-app)'; setCommModule(mod.toLowerCase()); };
                container.appendChild(btn);
            });
        });
        
        const bookSel = document.getElementById('sel-book');
        const ot=document.createElement('optgroup'); ot.label="Old Testament"; otBooks.forEach(b=>{ let o=document.createElement('option'); o.value=b; o.text=b; ot.appendChild(o); }); bookSel.appendChild(ot);
        const nt=document.createElement('optgroup'); nt.label="New Testament"; ntBooks.forEach(b=>{ let o=document.createElement('option'); o.value=b; o.text=b; nt.appendChild(o); }); bookSel.appendChild(nt);
        
        updateVerseSelector(); loadPane('pane-1'); loadPane('pane-2');
    };

    // --- Core Logic ---
    function switchTab(tabId) {
        const ribbon = document.getElementById('ribbon');
        const clickedTab = event.currentTarget;
        const currentActive = document.querySelector('.ribbon-tab.active');
        if (clickedTab === currentActive) { ribbon.classList.toggle('collapsed'); return; }
        ribbon.classList.remove('collapsed'); document.querySelectorAll('.ribbon-content').forEach(el => el.style.display = 'none'); document.getElementById(tabId).style.display = 'flex';
        document.querySelectorAll('.ribbon-tab').forEach(el => el.classList.remove('active')); clickedTab.classList.add('active');
        
        if (tabId === 'tab-comm') changePaneContent('pane-2', 'commentary');
        if (tabId === 'tab-dict') changePaneContent('pane-2', 'dictionary');
        if (tabId === 'tab-lex') changePaneContent('pane-2', 'lex_browse');
        if (tabId === 'tab-search') { changePaneContent('pane-2', 'search'); setTimeout(() => document.getElementById('inp-bible-search').focus(), 50); }
    }

    function setCommModule(mod) { state.commModule = mod.toLowerCase(); changePaneContent('pane-2', 'commentary'); const titleSpan = document.getElementById('pane-2-title'); const fullName = moduleNames[mod.toUpperCase()] || mod.toUpperCase(); titleSpan.innerText = `Commentary (${fullName})`; document.querySelectorAll('.module-card').forEach(btn => { if(btn.innerText === fullName || btn.innerText === mod.toUpperCase()) { document.querySelectorAll('.module-card').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }}); }
    function searchDict() { const term = document.getElementById('inp-dict-search').value; if(term) { state.lookupTerm = term; state.lookupType = 'dictionary'; changePaneContent('pane-2', 'dictionary'); } }
    function searchBible() { state.searchQuery = document.getElementById('inp-bible-search').value; const scopeVal = document.getElementById('sel-search-scope').value; state.searchScope = (scopeVal === 'CURRENT') ? state.book : scopeVal; if(state.searchQuery) { changePaneContent('pane-2', 'search'); } }
    function showDef(term, type = 'strong_hebrew') { state.lookupTerm = term; state.lookupType = type; changePaneContent('pane-2', 'dictionary'); }
    function navigate() { const newBook = document.getElementById('sel-book').value; const newChapter = document.getElementById('inp-chapter').value; if (newBook !== state.book) { state.book = newBook; state.chapter = 1; state.verse = 1; document.getElementById('inp-chapter').value = 1; } else { state.chapter = newChapter; state.verse = 1; } updateVerseSelector(); reloadPanes(); }
    function navStep(d) { let c = parseInt(document.getElementById('inp-chapter').value) + d; if(c < 1) c = 1; document.getElementById('inp-chapter').value = c; navigate(); }
    
    function updateThemeUI(t) { const btn = document.querySelector('#tab-settings button'); if (btn) { btn.innerText = (t === 'dark') ? 'Switch to Light Mode' : 'Switch to Dark Mode'; } }
    function toggleTheme() { const body = document.body; const current = body.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark'; body.setAttribute('data-theme', next); localStorage.setItem('theme', next); updateThemeUI(next); }
    function changeFontSize(d) { state.fontSize += d; if(state.fontSize < 12) state.fontSize = 12; if(state.fontSize > 32) state.fontSize = 32; applyFontSize(); localStorage.setItem('fontSize', state.fontSize); }
    function applyFontSize() { document.querySelectorAll('.pane-content').forEach(el => { el.style.fontSize = `${state.fontSize}px`; }); document.getElementById('lbl-font-size').innerText = `${state.fontSize}px`; }

    function setVerse(v) { state.verse = v; const sel = document.getElementById('sel-verse'); if(sel) sel.value = v; document.querySelectorAll('.verse-row').forEach(el => el.classList.remove('active')); const activeEl = document.getElementById(`v-${v}`); if(activeEl) activeEl.classList.add('active'); updateContextPanes(); }
    function setLayout(t) { document.getElementById('workspace').className = (t === 'vertical') ? 'layout-vertical' : 'layout-horizontal'; }
    function toggleMin(id) { document.getElementById(id).classList.toggle('minimized'); }
    function toggleMax(id) { document.getElementById(id).classList.toggle('maximized'); }
    function closePane(id) { document.getElementById(id).classList.add('closed'); }
    function resetLayout() { document.querySelectorAll('.pane').forEach(el => { el.classList.remove('closed', 'minimized', 'maximized'); }); }
    
    function switchRefModule(mod) { if (mod === 'HEBREW' || mod === 'GREEK') { state.lexModule = mod; changePaneContent('pane-2', 'lex_browse'); } else { state.dictModule = mod; changePaneContent('pane-2', 'dictionary'); } }
    function filterSidebar(q) { const items = document.querySelectorAll('.sidebar-item'); const l = q.toLowerCase(); items.forEach(el => { el.style.display = el.innerText.toLowerCase().includes(l) ? 'block' : 'none'; }); }
    function highlightItem(el) { document.querySelectorAll('.sidebar-item').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
    function searchLex() { const term = document.getElementById('inp-lex-search').value; if(term) { state.lookupTerm = term; state.lookupType = (state.lexModule === 'HEBREW') ? 'strong_hebrew' : 'strong_greek'; state.dictModule = state.lexModule; changePaneContent('pane-2', 'lex_browse'); } }

    function changePaneContent(paneId, type) {
        const pane = document.getElementById(paneId); pane.dataset.type = type; const titleSpan = document.getElementById(`${paneId}-title`);
        const select = pane.querySelector('select'); if(select) select.value = type;
        let commTitle = `Commentary (${state.commModule.toUpperCase()})`; if (moduleNames[state.commModule.toUpperCase()]) commTitle = moduleNames[state.commModule.toUpperCase()];
        const titles = { 'bible': 'Bible Text', 'commentary': commTitle, 'dictionary': `Dictionary (${state.dictModule})`, 'lex_browse': `Lexicon (${state.lexModule})`, 'xrefs': 'Cross References', 'search': `Search Results` };
        titleSpan.innerText = titles[type] || 'Pane';
        if (type === 'dict_browse') state.lookupTerm = "";
        loadPane(paneId);
    }

    function reloadPanes() { loadPane('pane-1'); updateContextPanes(); }
    function jumpTo(b, c, v) { state.book = b; state.chapter = c; state.verse = v; document.getElementById('sel-book').value = b; document.getElementById('inp-chapter').value = c; updateVerseSelector(); if (document.getElementById('pane-1').dataset.type !== 'bible') { changePaneContent('pane-1', 'bible'); } else { reloadPanes(); } }
    function openComm(mod, v) { state.verse = v; document.querySelectorAll('.verse-row').forEach(el => el.classList.remove('active')); const activeEl = document.getElementById(`v-${v}`); if(activeEl) activeEl.classList.add('active'); setCommModule(mod.toLowerCase()); }
    function toggleRibbon() { document.getElementById('ribbon').classList.toggle('collapsed'); }
    function toggleInterlinear() { state.interlinear = !state.interlinear; const btn = document.getElementById('btn-interlinear'); btn.innerText = state.interlinear ? "Interlinear: ON" : "Interlinear: OFF"; btn.style.color = state.interlinear ? "var(--accent)" : "var(--text-main)"; reloadPanes(); }
    function updateVerseSelector() { const sel = document.getElementById('sel-verse'); sel.innerHTML = ''; let count = 0; if (BIBLE_STRUCTURE[state.book]) { const chapterIdx = parseInt(state.chapter) - 1; if (BIBLE_STRUCTURE[state.book][chapterIdx]) { count = BIBLE_STRUCTURE[state.book][chapterIdx]; } } if (count > 0) { for(let i=1; i<=count; i++) { let opt = document.createElement('option'); opt.value = i; opt.text = i; if(i == state.verse) opt.selected = true; sel.appendChild(opt); } } else { let opt = document.createElement('option'); opt.text = "-"; sel.appendChild(opt); } }
    function scrollVerse(v) { const target = document.getElementById(`v-${v}`); if (target) { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }

    function loadPane(paneId) {
        const pane = document.getElementById(paneId); const type = pane.dataset.type; const contentDiv = document.getElementById(`${paneId}-content`);
        state.version = document.getElementById('sel-version').value || 'KJV';
        if (type === 'bible') {
            document.getElementById(`${paneId}-title`).innerText = `${state.book} ${state.chapter} (${state.version})`;
            fetch(`api.php?action=text&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&version=${state.version}&interlinear=${state.interlinear}`)
            .then(r => r.json()).then(data => {
                if (!data.verses) { contentDiv.innerHTML = "Error loading."; return; }
                let html = '';
                data.verses.forEach(v => {
                    let text = v.text;
                    if (!state.interlinear) { text = text.replace(/God/g, 'God<sup class="strongs" onclick="event.stopPropagation(); showDef(\'H430\', \'strong_hebrew\')">H430</sup>').replace(/beginning/g, 'beginning<sup class="strongs" onclick="event.stopPropagation(); showDef(\'H7225\', \'strong_hebrew\')">H7225</sup>'); }
                    let linksHtml = ''; if (v.modules) { const mods = v.modules.split(','); linksHtml = '<div class="verse-links">'; mods.forEach(m => { linksHtml += `<span class="v-link" onclick="event.stopPropagation(); openComm('${m}', ${v.verse})">${m}</span>`; }); linksHtml += '</div>'; }
                    html += `<div class="verse-row ${v.verse == state.verse ? 'active' : ''}" id="v-${v.verse}" onclick="setVerse(${v.verse})"><span class="v-num">${v.verse}</span>${text}${linksHtml}</div>`;
                });
                contentDiv.innerHTML = html; setTimeout(() => { const t = document.getElementById(`v-${state.verse}`); if(t) t.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            }).catch(e => console.error(e));
        } else { updatePaneContent(paneId); }
    }

    function updateContextPanes() { document.querySelectorAll('.pane').forEach(pane => { if (pane.dataset.type !== 'bible') { updatePaneContent(pane.id); } }); }

    function updatePaneContent(paneId) {
        const pane = document.getElementById(paneId); const type = pane.dataset.type; const contentDiv = pane.querySelector('.pane-content');
        contentDiv.style.display = 'block'; contentDiv.innerHTML = 'Loading...';
        
        if (type === 'commentary') {
            fetch(`api.php?action=commentary&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&verse=${state.verse}&module=${state.commModule}`)
            .then(r => r.json()).then(data => {
                contentDiv.innerHTML = `<div class="comm-card"><h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">${state.book} ${state.chapter}:${state.verse} (${state.commModule.toUpperCase()})</h3>${data.text || "No commentary found."}</div>`;
            });
        } else if (type === 'xrefs') {
            fetch(`api.php?action=xrefs&book=${encodeURIComponent(state.book)}&chapter=${state.chapter}&verse=${state.verse}`)
            .then(r => r.json()).then(data => {
                let html = `<div class="comm-card"><h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Cross References</h3><div style="display:flex; flex-wrap:wrap; gap:8px;">`;
                if(!data.xrefs || data.xrefs.length === 0) html += "None."; else data.xrefs.forEach(x => { html += `<span class="v-link" onclick="jumpTo('${x.book}', ${x.chapter}, ${x.verse})" style="font-size:13px; padding:6px 10px;">${x.book} ${x.chapter}:${x.verse}</span>`; });
                contentDiv.innerHTML = html + `</div></div>`;
            });
        } else if (type === 'dictionary' || type === 'lex_browse') {
            contentDiv.style.display = 'flex'; contentDiv.style.flexDirection = 'column'; contentDiv.style.padding = '0';
            let isLex = (type === 'lex_browse'); let currentMod = isLex ? state.lexModule : state.dictModule;
            let toolbarHtml = `<div style="flex:0 0 40px; background:var(--bg-app); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 10px; gap:8px;"><span style="font-size:11px; font-weight:bold;">Source:</span><select onchange="switchRefModule(this.value)" style="border:1px solid var(--border); padding:2px 4px; font-size:12px;"><optgroup label="Dictionaries"><option value="EASTON" ${currentMod=='EASTON'?'selected':''}>Easton</option><option value="SMITH" ${currentMod=='SMITH'?'selected':''}>Smith</option><option value="ATSD" ${currentMod=='ATSD'?'selected':''}>ATSD</option><option value="NAMES" ${currentMod=='NAMES'?'selected':''}>Names</option></optgroup><optgroup label="Lexicons"><option value="HEBREW" ${currentMod=='HEBREW'?'selected':''}>Hebrew</option><option value="GREEK" ${currentMod=='GREEK'?'selected':''}>Greek</option></optgroup></select><div style="flex:1;"></div><input type="text" placeholder="Filter..." onkeyup="filterSidebar(this.value)" style="padding:2px 5px; font-size:12px;"></div><div style="flex:1; display:flex; overflow:hidden;"><div id="dict-sidebar" style="width:220px; border-right:1px solid var(--border); overflow-y:auto; background:var(--bg-app);"><div id="dict-topics-list"></div></div><div id="dict-display" style="flex:1; padding:20px; overflow-y:auto;"></div></div>`;
            contentDiv.innerHTML = toolbarHtml;
            fetch(`api.php?action=topics&module=${currentMod}`).then(r => r.json()).then(data => {
                const listDiv = document.getElementById('dict-topics-list'); let html = ''; let defType = (currentMod === 'HEBREW') ? 'strong_hebrew' : (currentMod === 'GREEK') ? 'strong_greek' : 'dictionary';
                data.topics.forEach(t => { let activeClass = (t.id === state.lookupTerm) ? 'active' : ''; html += `<div class="sidebar-item ${activeClass}" onclick="showDef('${t.id}', '${defType}'); highlightItem(this);">${t.label}</div>`; });
                listDiv.innerHTML = html;
            });
            if(state.lookupTerm) { let defType = (currentMod === 'HEBREW') ? 'strong_hebrew' : (currentMod === 'GREEK') ? 'strong_greek' : 'dictionary'; fetch(`api.php?action=definition&term=${encodeURIComponent(state.lookupTerm)}&type=${defType}&module=${currentMod}`).then(r => r.json()).then(data => { document.getElementById('dict-display').innerHTML = `<div style="font-size:16px;">${(data.definition || "Not found.").replace(/\n/g, '<br>')}</div>`; }); }
        } else if (type === 'search') {
            if (!state.searchQuery) { contentDiv.innerHTML = `<div style="padding:20px; text-align:center;">Enter keywords.</div>`; return; }
            fetch(`api.php?action=search&q=${encodeURIComponent(state.searchQuery)}&version=${state.version}&scope=${encodeURIComponent(state.searchScope)}`).then(r => r.json()).then(data => {
                document.getElementById(`${paneId}-title`).innerText = `Search: ${state.searchQuery} (${data.count})`;
                let html = `<div style="padding:15px;">`;
                if(!data.results || data.results.length === 0) html += "None."; else data.results.forEach(r => { html += `<div class="comm-card" onclick="jumpTo('${r.book_name.replace(/'/g, "\\'")}',${r.chapter},${r.verse})"><b style="color:var(--accent); font-size:12px;">${r.book_name} ${r.chapter}:${r.verse}</b><br>${r.text}</div>`; });
                contentDiv.innerHTML = html + `</div>`;
            });
        }
    }
</script>
</body>
</html>
